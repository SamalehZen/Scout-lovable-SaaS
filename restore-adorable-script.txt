#!/bin/bash

# Script de restauration complÃ¨te d'Adorable avec configuration OpenRouter
# Usage: 
#   1. Copiez ce contenu dans un fichier restore-adorable.sh
#   2. chmod +x restore-adorable.sh
#   3. ./restore-adorable.sh

set -e

echo "ðŸ”„ Restauration complÃ¨te d'Adorable avec configuration OpenRouter"
echo "================================================================="

# Variables
BACKUP_ENV="/home/scrapybara/SamalehZen/Adorable-Lovable-clone-SaaS/.env"
ORIGINAL_REPO="https://github.com/freestyle-sh/adorable"
NEW_DIR="/home/scrapybara/adorable-complet"

# Fonctions d'affichage
print_success() { echo -e "\033[32mâœ… $1\033[0m"; }
print_error() { echo -e "\033[31mâŒ $1\033[0m"; }
print_info() { echo -e "\033[34mâ„¹ï¸  $1\033[0m"; }

# VÃ©rifier que le fichier .env existe
if [ ! -f "$BACKUP_ENV" ]; then
    print_error "Fichier .env non trouvÃ© dans $BACKUP_ENV"
    exit 1
fi

print_success "Configuration .env trouvÃ©e"

# Cloner le projet original
echo "1. Clonage du projet original..."
if [ -d "$NEW_DIR" ]; then
    print_info "Suppression de l'ancien rÃ©pertoire..."
    rm -rf "$NEW_DIR"
fi

git clone "$ORIGINAL_REPO" "$NEW_DIR"
print_success "Projet clonÃ© dans $NEW_DIR"

# Aller dans le nouveau rÃ©pertoire
cd "$NEW_DIR"

# Copier la configuration
echo "2. Copie de votre configuration..."
cp "$BACKUP_ENV" .env
print_success "Configuration .env copiÃ©e"

# Installer les dÃ©pendances avec OpenRouter
echo "3. Installation des dÃ©pendances (avec support OpenRouter)..."
npm install --legacy-peer-deps
npm install @ai-sdk/openai --legacy-peer-deps
print_success "DÃ©pendances installÃ©es"

# Appliquer les modifications OpenRouter
echo "4. Application des modifications OpenRouter..."

# Modifier src/lib/model.ts
cat > src/lib/model.ts << 'EOF'
import { createOpenAI } from "@ai-sdk/openai";

// Configuration OpenRouter avec modÃ¨le DeepSeek gratuit
const openrouter = createOpenAI({
  baseURL: "https://openrouter.ai/api/v1",
  apiKey: process.env.OPENROUTER_API_KEY,
});

export const MODEL = openrouter("deepseek/deepseek-r1-0528:free");
EOF

# Modifier src/mastra/agents/builder.ts pour utiliser OpenRouter
sed -i 's/import { anthropic } from "@ai-sdk\/anthropic";/import { MODEL } from "@\/lib\/model";/' src/mastra/agents/builder.ts
sed -i 's/model: anthropic("claude-3-7-sonnet-20250219"),/model: MODEL,/' src/mastra/agents/builder.ts

# Modifier .env.example
sed -i 's/ANTHROPIC_API_KEY=/OPENROUTER_API_KEY=sk-or-/' .env.example

print_success "Modifications OpenRouter appliquÃ©es"

# Initialiser la base de donnÃ©es
echo "5. VÃ©rification de la base de donnÃ©es..."
npx drizzle-kit push
print_success "Base de donnÃ©es vÃ©rifiÃ©e"

# Test final
echo "6. Test de la configuration..."
node -e "
require('dotenv').config();
console.log('âœ… Test rÃ©ussi !');
console.log('ðŸ”‘ OpenRouter:', process.env.OPENROUTER_API_KEY ? 'PrÃ©sent' : 'Manquant');
console.log('ðŸ—„ï¸ Database:', process.env.DATABASE_URL ? 'PrÃ©sent' : 'Manquant');
console.log('ðŸŽ¯ Freestyle:', process.env.FREESTYLE_API_KEY ? 'PrÃ©sent' : 'Manquant');
"

echo ""
echo "ðŸŽ‰ Restauration terminÃ©e avec succÃ¨s !"
echo "======================================"
print_success "Projet complet restaurÃ© dans: $NEW_DIR"
print_success "Configuration OpenRouter + DeepSeek R1 appliquÃ©e"
print_success "Base de donnÃ©es Neon fonctionnelle"

echo ""
echo "ðŸš€ Pour lancer l'application :"
echo "cd $NEW_DIR"
echo "npm run dev"
echo ""
echo "ðŸŒ Puis ouvrir: http://localhost:3000"
echo ""
print_info "Votre app Adorable sera 100% gratuite grÃ¢ce Ã  DeepSeek R1 !"